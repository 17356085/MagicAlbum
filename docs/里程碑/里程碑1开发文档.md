


          
**里程碑一开发文档（ACGN 多分区论坛 / 课设版）**

- 文档目标：明确里程碑一的范围、设计与评审材料，保证后续 100 天后能平滑演进到缓存、搜索、消息与微服务，不写代码也能评审通过。
- 项目定位：服务 ACGN 爱好者的多分区社区（番剧/漫画/游戏/轻小说），强调干净体验、可治理与可扩展。

**范围与目标**
- 核心功能：分区/主题帖/回复、注册登录（JWT）、基础权限（管理员/版主/会员/游客）、简单举报与审核、标题检索与分页排序。
- 非目标：推荐算法、全文检索（tsvector/ES）、实时推送、消息队列、复杂积分系统（放到后续里程碑）。
- 验收标准：功能覆盖到用户主路径（浏览→发帖→回复→举报→审核），接口与数据设计清晰，扩展性边界明确。

**用户与角色**
- 游客：浏览分区与帖子、检索。
- 会员：发帖、回复、举报。
- 版主：管理所在分区（置顶/锁帖/审核举报）。
- 管理员：全局管理（用户/分区/全站公告与审核）。

**关键用户故事**
- 作为会员，我能在番剧分区发主题帖，支持剧透标签与至少一个内容标签。
- 作为版主，我能查看分区的举报列表并更改状态为“已处理”，可锁帖。
- 作为游客，我能通过标题关键字检索主题帖并按最新/热度排序浏览。
- 作为管理员，我能创建分区、设定版规、设置版主角色。

**技术选型与原则**
- 后端：`Spring Boot`、`Spring Web`、`Spring Data JPA`、`Spring Security`、`JWT`。
- 数据库：优先 `PostgreSQL`（JSONB/扩展性好），兼容 `MySQL`。通过 `Profile` 切换，避免耦合。
- 前端：`Vue 3 + Vite`，`TailwindCSS`，请求以 `fetch/Axios`（Promise）。
- 迁移：`Flyway` 管理 SQL 版本；集成测试建议 `Testcontainers`（Postgres/MySQL 可切换）。
- 观测：结构化日志（Logback），后续扩展 `Micrometer` + `Prometheus/Grafana`。
- 文档：`OpenAPI/Swagger` 输出接口文档。

**架构分层与模块**
- Web 层：`Controller`（REST、DTO、分页/排序统一协议、错误码）。
- Application 层：`Service`（用例编排、事务边界、权限校验、缓存策略入口）。
- Domain 层：实体与聚合（用户/分区/主题帖/回复/举报/标签），领域服务（不依赖框架）。
- Infrastructure 层：`Repository`（JPA）、数据源与配置、外部服务接口（对象存储、邮件占位）。
- 扩展接口：
  - 缓存：在热点查询服务预留 `@Cacheable`（后续接入 `Redis`）。
  - 搜索：定义 `SearchService` 抽象（里程碑一用 SQL LIKE；后续替换 ES/tsvector）。
  - 事件：定义领域事件接口与 Outbox 位置（后续接 MQ）。
  - 版本化 API：`/api/v1/...`（将来多版本并存，便于迁移）。

**信息架构**
- 分区（Section）→ 主题帖（Thread）→ 回复（Post）→ 楼中楼（reply_to 可选）。
- 标签体系（Tag）：支持类型（ANIME/MANGA/GAME/NOVEL/CHARACTER），用于主题聚合与检索。
- 治理（Report）：举报目标（主题/回复），状态机（OPEN/REVIEWED/RESOLVED）。
- 版务：置顶/锁帖、公告卡片。

**数据模型（课设版）**
- users：id、username、email、password_hash、avatar_url、created_at
- roles：id、code（ADMIN/MOD/MEMBER）
- user_roles：user_id、role_id
- sections：id、name、slug、description、rules、created_at
- threads：id、section_id、author_id、title、content_md、spoiler、status（NORMAL/LOCKED/HIDDEN）、created_at、updated_at
- posts：id、thread_id、author_id、content_md、reply_to_post_id、created_at
- tags：id、name、type
- thread_tags：thread_id、tag_id
- reports：id、target_type（THREAD/POST）、target_id、reporter_id、reason、status（OPEN/REVIEWED/RESOLVED）、created_at
- 索引建议：
  - `threads(section_id, created_at)`
  - `threads(lower(title))`（Postgres）/ `threads(title)` + `COLLATE`（MySQL）
  - `posts(thread_id, created_at)`
  - `reports(status, created_at)`
- 可选扩展：
  - `thread_stats`：thread_id、replies_count、likes_count、heat_score（为排序与缓存预留）
  - `activity`：公告/活动信息（分区级）

**接口规范（API 草案）**
- 鉴权
  - `POST /api/v1/auth/register`
  - `POST /api/v1/auth/login` 返回 `accessToken`、`expiresIn`
  - `GET /api/v1/me`
- 分区
  - `GET /api/v1/sections`
  - `GET /api/v1/sections/{id}`
- 主题帖
  - `GET /api/v1/threads?sectionId=&q=&sort=&page=&size=`
    - `sort`: `newest` | `hot` | `replies`
    - 响应分页统一格式：`{ items: [], page: 1, size: 20, total: 123 }`
  - `GET /api/v1/threads/{id}`
  - `POST /api/v1/threads`（会员）
    - 请求：`{ sectionId, title, contentMd, spoiler, tagIds }`
  - `PATCH /api/v1/threads/{id}`（作者/版主）
  - `POST /api/v1/threads/{id}/lock`（版主）
- 回复
  - `GET /api/v1/threads/{id}/posts?page=&size=`
  - `POST /api/v1/threads/{id}/posts`（会员）
    - 请求：`{ contentMd, replyToPostId? }`
- 举报与审核
  - `POST /api/v1/reports`：`{ targetType, targetId, reason }`
  - `GET /api/v1/reports?status=&sectionId=&page=&size=`（版主/管理员）
  - `POST /api/v1/reports/{id}/resolve`（版主/管理员）
- 错误码与约定
  - `400` 参数错误、`401` 未登录、`403` 权限不足、`404` 资源缺失、`409` 冲突（如锁帖编辑）
  - 统一错误体：`{ code: "FORBIDDEN", message: "no permission", traceId }`

**权限与策略**
- 访问控制：`Spring Security` 路由级 + 资源级（作者或版主）判定。
- 版主作用域：按 `section_id` 授权；接口层校验。
- 发帖校验：分区必选、标题长度、标签至少一个、剧透提示（前端校验 + 后端兜底）。
- 举报限流：同用户/同目标短周期内一次；保留风控扩展位。

**前端原型（Vue + Tailwind）**
- 页面
  - 分区列表：展示分区卡片、公告。
  - 分区主题列表：分页、排序、标签过滤。
  - 主题详情：内容、剧透折叠、回复列表与楼中楼、发回复表单。
  - 发帖页：选择分区、标题、内容 Markdown、剧透开关、标签选择器。
  - 登录/注册：基本表单与错误提示。
  - 举报/审核页：列表 + 状态操作（版主/管理员）。
- 组件
  - 帖子卡片、分页器、标签选择器、剧透折叠块、公告栏、权限提示条。
- 调用策略
  - `axios` 封装、拦截器注入 `Authorization: Bearer <token>`，统一错误提示；Token 续期后置里程碑二。

**配置与数据库切换**
- 公共配置：`application.yml`（端口、日志、JPA 通用）
- Postgres 配置：`application-postgres.yml`
- `spring.datasource.url=jdbc:postgresql://localhost:5432/MagicAlbum`
  - `spring.jpa.database-platform=org.hibernate.dialect.PostgreSQLDialect`
- MySQL 配置：`application-mysql.yml`
- `spring.datasource.url=jdbc:mysql://localhost:3306/MagicAlbum?useSSL=false&serverTimezone=UTC`
  - `spring.jpa.database-platform=org.hibernate.dialect.MySQL8Dialect`
- 激活方式：`spring.profiles.active=postgres` 或 `mysql`
- 迁移：`Flyway` 脚本 `V1__init.sql` 定义基础表与索引；`V2__add_stats.sql` 等增量可选。

**日志与可观测**
- 结构化日志：记录 `traceId`、用户 id（若登录）、接口名、耗时。
- 关键事件：发帖、回复、锁帖、举报、审核状态变更。
- 指标预留：请求数、P95/P99 延迟、错误率（里程碑二接入）。

**性能与扩展**
- 查询优化：分页 + 索引；避免 N+1（JPA `fetch` 策略控制）。
- 缓存策略（预留）：分区列表、主题列表分页第一页、主题详情；`@Cacheable` + `CacheEvict`。
- 搜索扩展：里程碑一用 `LOWER(title) LIKE %q%`；里程碑二引入 `tsvector` 或 `Elasticsearch`，通过 `SearchService` 抽象切换。
- 消息与异步：定义领域事件接口与 Outbox 表占位；里程碑二接 `Kafka/RabbitMQ`。
- 微服务准备：模块边界清晰（用户/内容/治理/搜索），REST 契约稳定，数据自治思路；里程碑三再拆分。

**安全与治理**
- 内容治理：屏蔽词表（里程碑二），举报 + 人工审核为主。
- 鉴权：JWT、密码散列（BCrypt），防止暴力破解与字典攻击。
- 防护：输入校验、避免 XSS（输出转义/Markdown 渲染限制）、防 SQL 注入（JPA 参数化）、CSRF（使用 JWT + 同源策略）。

**测试计划（不编码版）**
- 功能测试：分区列表/详情、发帖/编辑、回复/楼中楼、举报与审核。
- 权限测试：游客访问受限、会员发帖、版主管理本分区、管理员全局。
- 边界测试：长标题/长内容、标签缺失、剧透标记、锁帖后编辑行为。
- 检索与分页：标题检索匹配准确性与排序一致性；分页边界。
- 数据一致性：删除主题联动删除回复（策略：允许软删除或限制删除）。
- 双数据库兼容：Postgres/MySQL 下 CRUD 与检索一致；差异字段/索引的说明。

**部署与运维（课设版）**
- 容器化占位：`Dockerfile` 与 `docker-compose.yml` 设计稿（里程碑二提供镜像与启动）。
- 运行环境：`dev` 使用 Postgres；`test` 可切 MySQL 验证兼容。
- 备份策略：数据库定期导出（手工说明）；日志存档策略（文件轮转）。

**风险与规避**
- 范围失控：严格聚焦“分区-主题-回复-举报-权限”，复杂功能后移。
- 双库差异：避免使用特有语法（先不启用 JSONB/数组），后续在 Postgres 替换可选字段。
- 性能不可控：第一页缓存与索引足够支撑课设演示；后续通过缓存/搜索/消息提升。
- 治理成本：举报 + 人工审核初期足够；后续引入规则与第三方内容审核。

**时间计划（建议 6 周）**
- 第1周：PRD 与原型（页面与流程）输出。
- 第2周：架构分层、模块职责、扩展点文档。
- 第3–4周：数据设计（ER/字典/索引）、API 规范与错误码。
- 第5周：测试计划、运维与配置策略（双库切换）。
- 第6周：整合评审资料与演示脚本（无需编码）。

**交付清单（课设评审材料）**
- 需求说明书：用户故事、分区与版规、流程图（发帖/回复/举报/审核）。
- 概要设计：分层架构、模块说明、扩展策略（缓存/搜索/消息/微服务）。
- 数据库设计：ER 图、数据字典、索引策略、双库兼容点说明。
- 接口规范：API 列表、字段与示例响应、错误码约定、分页与排序协议。
- 测试计划：权责验证用例、功能与边界用例、检索与分页用例。
- 运维与部署稿：Profile 切换、依赖与环境、容器化草案。
- 评审演示脚本：不编码也能用原型图与数据字典讲清楚“从需求到实现”的闭环。

**下一步**
- 如果你需要，我可以马上把“需求说明书”、“概要设计”、“数据库设计（ER/字典）”、“API 规范”和“测试计划”的完整初稿生成为 Markdown 文档，便于你直接修改和提交。你只需告诉我是否需要我按上述结构输出成 5 份文档的正文内容。
        