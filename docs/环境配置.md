# 环境配置与运行指南（里程碑一）

本文档说明如何在本地配置 MagicAlbum 后端的运行环境，并在 PostgreSQL 与 MySQL 间切换。

## 前置依赖
- JDK `21`
- Maven `3.9+`
- Docker Desktop（用于一键启动数据库，可选）

## 目录结构（关键部分）
- `end/pom.xml`：后端依赖与构建配置
- `end/src/main/resources/application.yml`：通用配置（默认激活 `postgres` profile）
- `end/src/main/resources/application-postgres.yml`：PostgreSQL 专用配置
- `end/src/main/resources/application-mysql.yml`：MySQL 专用配置
- `end/src/main/resources/db/migration/V1__init.sql`：Flyway 初始迁移占位
- `docker-compose.yml`：Postgres/MySQL 一键启动示例

## 启动数据库（二选一）
在项目根目录：

### 启动 Postgres
```bash
docker compose up -d postgres
```
- 连接信息：
  - `host=localhost`, `port=5432`
- `db=MagicAlbum`, `user=MagicAlbum`, `password=MagicAlbum`

### 启动 MySQL
```bash
docker compose up -d mysql
```
- 连接信息：
  - `host=localhost`, `port=3306`
- `db=MagicAlbum`, `user=MagicAlbum`, `password=MagicAlbum`
  - `root password=rootpass`

## 选择数据库与运行后端
默认激活 `postgres`，如需切换数据库或覆盖连接参数，可使用 `spring profiles` 或环境变量。

### 使用 Profiles
在项目根目录运行：
```bash
# 使用 Postgres（默认）
mvn -f end/pom.xml spring-boot:run -Dspring-boot.run.profiles=postgres

# 切换到 MySQL
mvn -f end/pom.xml spring-boot:run -Dspring-boot.run.profiles=mysql
```

### 使用环境变量覆盖
```bash
set DB_HOST=localhost
set DB_PORT=5432
set DB_NAME=MagicAlbum
set DB_USER=MagicAlbum
set DB_PASSWORD=MagicAlbum
mvn -f end/pom.xml spring-boot:run -Dspring-boot.run.profiles=postgres
```
在 PowerShell 下可使用 `$env:DB_HOST="localhost"` 语法。

## Flyway 迁移
- 已启用 Flyway（`spring.flyway.enabled=true`）。
- 初始迁移文件为占位，后续里程碑将填充实际表结构。
- 变更时按 `db/migration/V{version}__{desc}.sql` 命名规则新增脚本。

## 日志与调试
- `org.hibernate.SQL=DEBUG` 已启用，便于观察 SQL 输出（生产环境建议降级）。
- 统一时区为 `UTC`，避免跨环境时间偏差。

## 常见问题
- 无法连接数据库：确认 Docker 服务运行、端口未被占用、`profiles` 与连接参数一致。
- 依赖下载慢：可配置 Maven 镜像源；当前使用 Spring Boot `4.0.2-SNAPSHOT`，如需稳定版可改用 `3.3.x`。

## 下一步
- 在 `V1__init.sql` 中添加核心表结构（users/roles/sections/threads/posts/tags/reports）。
- 增加 `application-test.yml` 与 Testcontainers 做集成测试（可选）。