# Redis 实战手册

## 1. 数据结构与适用场景

Redis 支持多种数据结构，每种都有其特定的应用场景。

### 1.1 String (字符串)
- **描述**: 最基本的数据类型，二进制安全，可以包含任何数据（如图片或序列化对象）。
- **场景**: 
  - 缓存（Session、HTML页面、API结果）。
  - 计数器（点赞数、访问量 `INCR`）。
  - 分布式锁 (`SETNX`)。

### 1.2 List (列表)
- **描述**: 简单的字符串列表，按插入顺序排序。底层是双向链表。
- **场景**:
  - 消息队列（简单场景，`LPUSH` + `RPOP`）。
  - 最新列表（如最新的10个帖子）。

### 1.3 Set (集合)
- **描述**: 字符串的无序集合，元素唯一。
- **场景**:
  - 标签（Tagging）。
  - 共同好友（求交集 `SINTER`）。
  - 抽奖（随机获取元素 `SRANDMEMBER`）。

### 1.4 Hash (哈希)
- **描述**: 键值对集合，适合存储对象。
- **场景**:
  - 用户信息存储（Key: userID, Field: name, age...）。
  - 购物车。

### 1.5 ZSet (有序集合)
- **描述**: 类似于 Set，但每个元素都会关联一个 double 类型的分数 (score)，根据分数排序。
- **场景**:
  - 排行榜（游戏排名、热搜榜）。
  - 延时任务（Score 为执行时间戳）。

## 2. 缓存策略与优化

### 2.1 缓存更新策略
- **Cache Aside Pattern (旁路缓存)**: 最常用的策略。
  - 读：先读缓存，命中返回；未命中读 DB，写入缓存后返回。
  - 写：先更新 DB，然后删除缓存（Lazy Loading）。
- **Read/Write Through**: 应用只与缓存交互，缓存负责与 DB 交互。
- **Write Behind**: 应用只写缓存，缓存异步批量写入 DB（数据一致性较差，高性能）。

### 2.2 缓存问题
- **缓存穿透**: 查询不存在的数据，导致请求直接打到 DB。
  - 解决：布隆过滤器、缓存空对象。
- **缓存击穿**: 热点 Key 过期瞬间，大量请求打到 DB。
  - 解决：互斥锁、逻辑过期。
- **缓存雪崩**: 大量 Key 同时过期或 Redis 宕机。
  - 解决：过期时间加随机值、Redis 高可用、限流降级。

### 2.3 性能优化
- 避免使用 `KEYS *`，使用 `SCAN` 代替。
- 控制 Key 的长度和 Value 的大小（BigKey 问题）。
- 合理使用 Pipeline 批量操作。

## 3. 持久化配置

### 3.1 RDB (Redis Database)
- **原理**: 定时将内存快照保存到磁盘（dump.rdb）。
- **优点**: 恢复速度快，文件紧凑。
- **缺点**: 可能会丢失最后一次快照后的数据。

### 3.2 AOF (Append Only File)
- **原理**: 记录每次写操作命令到文件。
- **策略**: `always` (每条命令), `everysec` (每秒, 推荐), `no`.
- **优点**: 数据更安全。
- **缺点**: 文件体积大，恢复速度慢。

### 3.3 混合持久化
- Redis 4.0+ 支持 RDB + AOF 混合使用。

## 4. 高可用与分布式

### 4.1 主从复制 (Replication)
- 主节点 (Master) 负责写，从节点 (Slave) 负责读。
- 实现读写分离，提高读性能。

### 4.2 哨兵机制 (Sentinel)
- 监控主从节点状态。
- 主节点宕机时，自动选举新的主节点（故障转移）。
- 提供客户端服务发现功能。

### 4.3 Redis Cluster
- 去中心化的分布式解决方案。
- 数据分片 (Sharding)，支持海量数据存储。
- 只有当集群中一半以上的节点都不可用时，整个集群才不可用。

## 5. 实战应用

### 5.1 分布式锁
- 使用 `SET key value NX PX timeout` 原子命令。
- 结合 Redisson 框架实现看门狗机制（自动续期）。

### 5.2 秒杀系统
- 预减库存：将库存预热到 Redis。
- 使用 Lua 脚本保证 `GET` (检查库存) 和 `DECR` (扣减库存) 的原子性。
- 异步下单：扣减成功后发送消息到 MQ，后台慢慢创建订单。

## 6. 本项目应用指南
- **依赖**: `spring-boot-starter-data-redis`.
- **客户端**: 推荐使用 `Lettuce` 或 `Jedis`.
- **工具类**: 封装 `RedisTemplate` 操作常用数据结构。
