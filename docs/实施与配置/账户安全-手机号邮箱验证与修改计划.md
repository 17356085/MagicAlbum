# 账户安全：手机号/邮箱验证码登录与修改方案（计划）

本文档规划“手机号、邮箱验证码登录”和“修改手机号、邮箱”的技术实现方案，明确目标、接口、数据模型、安全与风控、前端交互、测试与上线步骤，便于后续迭代实现。

## 目标与范围
- 目标：
  - 支持通过手机号或邮箱的“验证码登录”（无密码、一次性验证码/魔法链接）。
  - 在“设置 → 账号信息”中支持修改绑定的手机号、邮箱（含校验与风控）。
  - 统一验证码服务接口，便于拓展到注册、找回密码、敏感操作确认等场景。
- 非目标：
  - 本阶段不实现完整的多因素认证（2FA/TOTP）。
  - 不改动现有“用户名+密码”登录流程，仅新增验证码登录为并行能力。

## 用户体验与流程
- 验证码登录（手机号）：
  1) 用户输入手机号；点击“获取验证码”；显示倒计时（60s）。
  2) 收到短信验证码后输入；提交；后端校验通过后签发 JWT 并登录。
  3) 首次登录可提示补充/确认账号信息（可选）。
- 验证码登录（邮箱）：
  - 两种形态，择一或两者并存：
    - 6 位数字验证码；与手机号一致的交互。
    - 魔法链接：邮件中附带一次性链接（含 token），点击后在浏览器里完成登录。
- 修改手机号：
  1) 验证当前身份（任一即可）：当前密码 或 当前手机号验证码。
  2) 发送验证码到新手机号；输入验证码完成绑定更新。
  3) 成功后触发安全日志与通知（站内/邮件可选），并设定短暂冷却期。
- 修改邮箱：
  1) 验证当前身份：当前密码 或 当前邮箱验证码。
  2) 发送验证码/魔法链接到新邮箱；完成绑定更新。
  3) 成功后触发安全日志与通知，并设定冷却期。

## 后端接口设计（草案）
- 统一验证码发送接口：
  - `POST /api/v1/auth/send-code`
  - 请求：`{ channel: 'phone'|'email', address: '138...'/ 'name@example.com', scene: 'login'|'bind'|'change_phone'|'change_email'|'reset_pwd' }`
  - 返回：`{ requestId: string, expireSeconds: number }`
- 统一验证码校验接口：
  - `POST /api/v1/auth/verify-code`
  - 请求：`{ channel, address, scene, code, requestId }`
  - 返回：`{ valid: boolean }`（如用于登录，可直接返回会话信息或在登录接口中二次校验）
- 验证码登录（手机号）：
  - `POST /api/v1/auth/login/phone`
  - 请求：`{ phone: string, code: string, requestId?: string }`
  - 返回：`{ accessToken: string, user: UserDto }`
- 验证码登录（邮箱）：
  - 数字码：`POST /api/v1/auth/login/email`，同上。
  - 魔法链接：`GET /api/v1/auth/magic-login?token=...`，一次性令牌换取登录态。
- 修改手机号：
  - 启动：`POST /api/v1/users/me/phone/change/start`，请求：`{ newPhone: string }` → 发送验证码到新手机号。
  - 完成：`POST /api/v1/users/me/phone/change/finish`，请求：`{ newPhone: string, code: string, proof?: { type: 'password'|'code', value: string } }`
- 修改邮箱：
  - 启动：`POST /api/v1/users/me/email/change/start`，请求：`{ newEmail: string }` → 发送验证码/魔法链接到新邮箱。
  - 完成：`POST /api/v1/users/me/email/change/finish`，请求同上。
- 查询安全状态：
  - `GET /api/v1/users/me/security` → 返回是否绑定 phone/email、最近修改时间、是否开启冷却等。

## 数据模型与存储
- `verification_codes` 表（或统一缓存层）：
  - 字段：`id`, `channel`, `address`, `scene`, `code_hash`, `expire_at`, `attempt_count`, `status`(created|used|expired|blocked), `ip`, `user_id`(可空), `created_at`。
  - 约束：每 `(channel,address,scene)` 在有效期内只保留最近一条；校验成功后标记为 `used`。
- 业务关联：
  - 新手机号/邮箱变更时，写入 `users.phone` / `users.email`（已存在唯一索引）。
  - 记录审计日志表 `security_audit_logs`（操作类型、发起用户与 IP、结果、时间）。

## 安全与风控
- 验证码：
  - 6 位数字；后端仅存 `HMAC(code)`；比较使用常量时间；默认 5 分钟有效。
  - 单地址速率限制：例如 1 次/60s；每天上限 5～10 次；超限拉黑或提示稍后再试。
  - IP 级限流与黑名单；对一次性邮箱域名进行灰名单限制（可选）。
  - 魔法链接：一次性 JWT（或随机 token）+ 短 TTL + 单次使用 + 绑定设备/UA（可选）。
- 绑定信息修改：
  - 需要“当前身份证明”（当前密码 或 当前地址验证码）。
  - 成功后冷却：例如 24 小时内限制再次修改；并推送站内/邮件安全通知。
  - 敏感字段修改失败或被限流，统一返回不暴露存在性的错误信息。

## 配置与第三方集成
- 短信：对接厂商（如阿里云短信/腾讯云短信/国内其他），通过环境变量配置模板 ID、签名、密钥、地区。
- 邮件：SMTP 或厂商（SendGrid、阿里、腾讯）；支持 HTML 模板与本地开发“控制台打印”模式。
- 环境变量：
  - `VITE_USE_API_MOCK`（前端 mock）、`SMS_*`、`MAIL_*`、`CODE_TTL_SECONDS`、`CODE_RATE_LIMITS`。

## 前端改造计划
- 登录弹窗（`LoginModal.vue`）：
  - 新增“验证码登录”页签（手机号/邮箱），输入地址 → 获取验证码（倒计时） → 输入验证码 → 登录。
  - 状态提示与错误处理（倒计时、重试、限流提示）。
- 设置页面（`SettingsAccount.vue`）：
  - “修改手机号/邮箱”使用双步骤：身份验证 + 新地址验证码；成功后刷新基础信息。
  - 显示最近修改时间与冷却状态；避免频繁变更。

## 后端实现步骤（分阶段）
1. 抽象验证码服务与存储模型，完成 `send-code/verify-code` 接口与限流策略。
2. 打通手机号验证码登录：`/auth/login/phone`。
3. 打通邮箱验证码登录（数字码）；可选实现魔法链接版本。
4. 实现手机号/邮箱修改的启动与完成接口，接入唯一性校验与冷却机制。
5. 安全审计日志与通知（可选邮件/站内）。

## 测试计划（要点）
- 单元测试：验证码生成/哈希/校验、过期/使用状态、限流策略。
- 集成测试：完整登录链路（发送→校验→登录）、修改绑定链路（身份验证→新地址校验→更新）。
- 安全测试：暴力尝试、并发提交、重放攻击、越权修改、信息泄露。
- 前端 E2E：登录弹窗与账号信息页交互、倒计时与错误文案。

## 上线与回滚
- 灰度发布：先开启邮箱验证码登录（风险较低），再开启短信；短信限流更严格。
- 监控与告警：验证码发送失败率、登录成功率、异常峰值、黑名单增长量。
- 回滚策略：逐步关闭 scene；保留密码登录为兜底。

## 开放问题（后续决策）
- 邮箱登录采用“数字码”还是“魔法链接”优先？两者同时存在的文案与引导如何设计？
- 短信与邮件供应商的选型与成本控制策略；是否需要支持多厂商容灾？
- 是否需要在高风险操作时强制 2FA？

---
备注：本计划不立即开发，实现时将以本文档为蓝图拆分任务与里程碑；当前系统的唯一索引已覆盖 `username/email/phone`，可直接支撑绑定变更的并发安全性。