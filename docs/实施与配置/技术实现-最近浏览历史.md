# 最近浏览历史（LocalStorage + 路由钩子）技术实现

## 账号隔离说明（2025-12-27 更新）

- 为避免同一浏览器内不同账号的浏览历史相互混杂，前端已将本地存储键调整为“按账号隔离”的策略。
- 存储键格式：`recent_visits_v1:<userId>`（优先使用 `id` 或 `userId`），当未登录时使用 `recent_visits_v1:guest`。
- 读取、写入、清空均使用动态键，路由钩子逻辑不变。
- 旧版本的通用键 `recent_visits_v1` 不再使用；如需迁移，可在登录后检查并合并到当前账号的键。

> 注意：历史记录只在本机浏览器中保存，不会与后端同步；清除浏览器数据或更换设备会影响记录。

更新时间：2025-12-27

## 概述
- 目标：在前端记录用户最近打开的帖子详情，供侧栏简表和“历史记录”页查看。
- 方案：使用 Vue Router `afterEach` 钩子在前端记录，持久化到浏览器 `localStorage`；显示时进行筛选与分页；详情页加载后补齐标题与分区信息。

## 路由追踪与初始化
- 入口文件：`front/src/main.js`
- 关键调用：
  - `import { initRecentVisitsTracking } from './composables/useRecentVisits'`
  - `initRecentVisitsTracking(router)`
- 工作机制：在 `router.afterEach` 中拦截页面跳转，仅对允许的路由（帖子详情）记录访问。

## 存储设计
- 存储位置：`localStorage` 键名 `recent_visits_v1`。
- 数据结构：数组，元素为 `{ path, name, title, id, sectionId, sectionName, ts }`。
- 去重策略：
  - 优先按 `id` 去重；
  - 无 `id` 时按基础 `path`（去除 `query` 与 `hash`）去重。
- 上限与过期：
  - 最多保留 `MAX_ITEMS = 10` 条；
  - 只保留最近 `MAX_AGE_MS = 7 天` 内记录。
- 事件通知：每次写入后会触发 `window.dispatchEvent(new CustomEvent('recent-visits-updated'))`，便于侧栏刷新。
- 关键代码：`front/src/composables/useRecentVisits.js`
  - 入口函数：`initRecentVisitsTracking(router)`、`addVisit(payload)`、`getRecentVisits(limit)`、`getAllRecentVisits()`、`clearAllRecentVisits()`、`pruneExpired()`。
  - 信息补齐：`updateVisitTitleById(id, title)`、`updateVisitSectionById(id, sectionId, sectionName)`。

## 信息补齐（详情页）
- 文件：`front/src/pages/ThreadDetail.vue`
- 在帖子详情加载完成后，调用：
  - `updateVisitTitleById` 更新标题（防止初次记录时标题为空或不准确）。
  - `updateVisitSectionById` 补齐分区信息（`sectionId/sectionName`）。

## 展示与交互
### 侧栏（最近浏览简表）
- 文件：`front/src/components/SidebarLeft.vue`
- 数据源：`getRecentVisits(5)` 读取前 5 条，监听 `recent-visits-updated` 事件自动刷新。
- 清除：点击“清除”按钮会删除 `recent_visits_v1` 并刷新列表。

### 历史记录页面（完整列表）
- 文件：`front/src/pages/RecentHistory.vue`
- 数据源：`getAllRecentVisits()` 并进行：
  - 关键词搜索（标题/名称/路径）；
  - 分区筛选；
  - 时间倒序；
  - 本地分页（默认每页 20 条）。
- 搜索触发方式：非实时。
  - 输入框使用本地状态 `searchText`；
  - 仅在“按回车”或点击“搜索”按钮时调用 `applySearch()` 同步到 `query.q` 并重置页码。
- 其他：标题栏左上角内置返回箭头；支持“清空”全部历史。

## 权限与可见性
- 存储与登录：记录存储在浏览器本地，与登录状态无关；登出不会自动清空。
- 页面可见性：
  - 侧栏“最近浏览”仅在登录状态显示（`isLoggedIn` 控制）。
  - 历史记录页未登录会重定向到“发现”页。

## 可配置项
- `front/src/composables/useRecentVisits.js` 中可调整：
  - `MAX_ITEMS`：最大保存条数（默认 10）。
  - `MAX_AGE_MS`：保留时间窗口（默认 7 天）。
  - `ALLOWED_ROUTE_NAMES`：允许记录的路由名集合（默认只记录 `thread-detail`）。

## 可选改造（按需）
- 登出即清空：在 `useAuth.logout()` 内额外移除 `recent_visits_v1`。
- 按用户维度存储：将键名改为 `recent_visits_${userId}`，避免不同用户的记录混淆；登出时不显示但不强制清空。
- 服务器侧存储：后续可将本地记录上报到后端，支持跨设备同步与账号维度治理。

## 关联文件索引
- 初始化：`front/src/main.js`
- 路由：`front/src/router/index.js`（包含 `scrollBehavior`，普通导航滚动到顶部，返回保留位置，哈希定锚）
- 记录/读写：`front/src/composables/useRecentVisits.js`
- 侧栏展示：`front/src/components/SidebarLeft.vue`
- 历史页展示：`front/src/pages/RecentHistory.vue`
- 详情页补齐：`front/src/pages/ThreadDetail.vue`

## 维护建议
- 若更改路由名称或详情页路径，请同步更新 `ALLOWED_ROUTE_NAMES` 以确保继续记录。
- 若调整条数或时长，请评估侧栏与历史页的分页与文案是否需要同步修改。