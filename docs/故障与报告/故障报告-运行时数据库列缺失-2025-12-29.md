# 故障报告：运行时数据库列缺失 (Unknown column 'summary')

**日期**: 2025-12-29
**状态**: 已修复
**模块**: end (后端/数据库)

## 1. 问题描述
后端应用启动后，访问 `/api/v1/threads` 接口时报 `500 Internal Server Error`。
错误日志显示：
```text
java.sql.SQLSyntaxErrorException: Unknown column 't1_0.summary' in 'field list'
```
Hibernate 生成的 SQL 试图查询 `summary` 和 `summary_status` 字段，但数据库表中不存在这些列。

## 2. 原因分析
1.  **代码与数据库不一致**：Java 实体类 `Thread.java` 中已添加了 `summary` 和 `summary_status` 字段，但数据库 Schema 未同步更新。
2.  **Flyway 迁移未执行**：
    *   最初提供的迁移脚本 `V20251231_1__add_thread_summary.sql` 未能被 Flyway 识别或执行（可能因版本号命名规范或应用未重启）。
    *   重命名为 `V16__add_thread_summary.sql` 后，用户应用未重启，导致 Flyway 仍未运行。
    *   即便重启，可能因历史版本冲突导致 Flyway 跳过脚本。

## 3. 解决方案

### 3.1 临时热修复（强制生效）
为了在不依赖 Flyway 状态的情况下确保应用可用，实施了以下**强制修复**措施：

创建组件 `com.example.demo.common.config.SchemaFixer`：
*   实现 `CommandLineRunner` 接口，随应用启动自动运行。
*   查询 `information_schema` 检查 `threads` 表是否存在 `summary` 列。
*   如果不存在，直接通过 JDBC 执行 `ALTER TABLE` 语句添加缺失列。

```java
// SchemaFixer.java 核心逻辑
if (count == 0) {
    jdbcTemplate.execute("ALTER TABLE threads ADD COLUMN summary TEXT");
    jdbcTemplate.execute("ALTER TABLE threads ADD COLUMN summary_status VARCHAR(32) DEFAULT 'PENDING'");
    jdbcTemplate.execute("UPDATE threads SET summary_status = 'PENDING' WHERE summary IS NULL");
}
```

### 3.2 长期维护
*   保留 `src/main/resources/db/migration/mysql/V16__add_thread_summary.sql` 文件，确保新环境部署时通过标准 Flyway 流程创建列。
*   `SchemaFixer.java` 可在确认所有环境（开发/生产）数据库均已同步后删除。

## 4. 验证结果
应用重启后，`SchemaFixer` 检测到列缺失并自动补全 Schema。再次访问 API 接口，请求成功，不再报错。

## 5. 经验总结
*   **Flyway 机制**：Flyway 仅在应用启动时运行。添加新脚本后必须重启应用。
*   **容错处理**：在开发环境中，当 Flyway 状态混乱时，编写临时的 `CommandLineRunner` 是一种快速恢复环境的有效手段。
