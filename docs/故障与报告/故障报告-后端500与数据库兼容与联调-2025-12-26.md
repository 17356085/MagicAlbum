# 后端 500 与数据库兼容故障报告（2025-12-26）

## 概要（Executive Summary）
- 症状：在本地 `H2` 环境下，`/api/v1/sections` 与 `/api/v1/threads` 接口返回 500；在初始 MySQL 联调时，用户侧反馈“所有 API 仍 500”。
- 根因：
  - `H2` 对 `CLOB/TEXT` 类型执行 `LOWER/LIKE` 不兼容，导致基于模糊搜索的查询报错（`/threads`）。
  - `local` 配置与 `H2` 迁移路径无实际建表脚本，导致部分接口（如登录）缺表触发 500。
  - MySQL 联调阶段的“所有 500”主要因后端未成功运行或端口未监听（进程退出/终止），并非业务逻辑异常。
- 处置：
  - 新增迁移脚本将 `threads.content_md` 从 `TEXT/CLOB` 改为 `VARCHAR(16384)`，规避 `H2` 的 CLOB 查询不兼容。
  - 固化后端默认 Profile 为 `mysql`；将 MySQL 默认凭据设置为用户提供值，降低 IDE 启动门槛。
  - 启动并验证在 MySQL 下接口均返回 200（公开接口），鉴权接口行为符合预期（401/400）。
- 当前状态：问题已在 MySQL 环境下解决并验证通过；H2 环境在新增类型迁移后也可正常执行查询。

---

## 影响范围
- `GET /api/v1/sections`：在 H2 环境下可能因缺表/迁移未执行导致 500。
- `GET /api/v1/threads`：在 H2 环境下对 `content_md` 的 `LOWER/LIKE` 查询对 `CLOB` 不兼容导致 500。
- `POST /api/v1/auth/login`：在 H2 环境缺表时返回 500；在 MySQL 环境使用种子用户（密码哈希为 `dummy`）会返回 401（预期）。
- `GET /api/v1/users/me`：未携带有效 Token 时返回 400（当前实现的预期行为）。

---

## 根因分析（Root Cause）
1. H2 与查询不兼容：
   - 现有查询对 `threads.content_md` 执行 `LOWER(...) LIKE ...`。
   - 在 H2 中该列类型为 `CLOB/TEXT`，`LOWER/LIKE` 与 `CLOB` 的组合不兼容，触发 500。

2. 迁移脚本分布不一致：
   - `local` Profile 的 Flyway 路径为 `classpath:db/migration`，但缺少实际建表脚本，导致 H2 启动后无表。
   - MySQL 的脚本位于 `classpath:db/migration/mysql`，若未切换至 `mysql` Profile，H2 环境下无法获得对应 schema。

3. 启动方式与端口监听：
   - 在 MySQL 联调时出现“所有 500”的情况，后台日志显示进程启动后被终止或未保持运行，导致 8080 未监听，前端/脚本请求失败。

---

## 修复措施（Fixes Implemented）
1. 新增并执行数据库迁移（H2 兼容性修复）：
   - 文件：`end/src/main/resources/db/migration/V20251231__alter_threads_content_to_varchar.sql`
   - 内容：将 `threads.content_md` 类型从 `TEXT/CLOB` 修改为 `VARCHAR(16384)`，使 `LOWER/LIKE` 查询兼容。

2. 固化后端配置为 MySQL 默认：
   - 更新 `end/src/main/resources/application.yml`：
     - `spring.profiles.active: mysql`（可按需切换为 `local` 或 `postgres`）。
   - 更新 `end/src/main/resources/application-mysql.yml`：
     - `spring.datasource.url=jdbc:mysql://localhost:3306/MagicAlbum?...`
     - `spring.datasource.username=${DB_USER:root}`
     - `spring.datasource.password=${DB_PASSWORD:04126}`
   - 目的：在 IDE 直接运行时无需额外设置环境变量即可连接用户提供的 MySQL。

3. 前端联调配置确认：
   - `front/.env`：
     - `VITE_API_BASE_URL=http://localhost:8080/api/v1`
     - `VITE_USE_API_MOCK=false`

---

## 验证结果（Verification）
后端启动日志关键片段：
```text
The following 1 profile is active: "mysql"
Tomcat started on port 8080 (http) with context path '/'
```

接口验证：
- `GET /api/v1/sections` → 200，返回 9 个预置分区数据。
- `GET /api/v1/threads?keyword=&page=1&size=20` → 200，返回主题列表（含样例用户 `fuckuser` 的帖子）。
- `POST /api/v1/auth/login` 使用 `fuckuser@example.com / foobar123` → 401（预期，因为种子用户密码哈希为 `dummy`）。
- `GET /api/v1/users/me` 未携带 Token → 400（符合当前实现的预期行为）。

---

## 复现与操作步骤（Reproduction & Ops）
1. 启动后端（IDE 直接运行即可）：
   - 由于已固化为 `mysql`，无需设置环境变量；若需要，可手动覆盖：
   ```powershell
   $env:SPRING_PROFILES_ACTIVE="mysql"
   $env:DB_HOST="localhost"; $env:DB_PORT="3306"; $env:DB_NAME="MagicAlbum"; $env:DB_USER="root"; $env:DB_PASSWORD="04126"
   .\mvnw.cmd spring-boot:run
   ```

2. 验证接口：
   ```powershell
   Invoke-RestMethod -Uri "http://localhost:8080/api/v1/sections"
   Invoke-RestMethod -Uri "http://localhost:8080/api/v1/threads?keyword=&page=1&size=20"
   ```

3. 登录与鉴权验证：
   - 注册一个新用户后再登录（样例用户无法登录）：
   ```powershell
   $reg = '{"username":"testuser","email":"testuser@example.com","phone":"13800000000","password":"foobar123"}'
   Invoke-RestMethod -Uri "http://localhost:8080/api/v1/auth/register" -Method POST -ContentType "application/json" -Body $reg

   $login = '{"email":"testuser@example.com","password":"foobar123"}'
   $resp = Invoke-RestMethod -Uri "http://localhost:8080/api/v1/auth/login" -Method POST -ContentType "application/json" -Body $login
   $token = $resp.accessToken
   Invoke-RestMethod -Uri "http://localhost:8080/api/v1/users/me" -Headers @{ Authorization = "Bearer $token" }
   ```

4. 启动前端开发服务器：
   ```bash
   npm run dev
   # 预览： http://localhost:5173/
   ```
   - 页面联调：
     - `http://localhost:5173/sections` → 显示 9 个分区。
     - 列表页/发现页 → 正常拉取 `/threads` 数据。

---

## 防止复发的改进建议（Prevention & Improvements）
- 配置与迁移：
  - 保持各 `profile` 的 Flyway 路径一致或提供对应脚本，避免某环境下缺表。
  - 在 `ApplicationRunner` 中增加关键表存在性检查，输出友好提示与文档指引。
- 启动与脚本：
  - 提供标准化启动脚本（Windows/Unix），封装 `DB_*` 与 `SPRING_PROFILES_ACTIVE`，降低手误概率。
- 测试保障：
  - 引入 `Testcontainers` 做集成测试，确保迁移在 MySQL/Postgres/H2 三者下可用或至少在目标环境可用。
  - 为核心接口增加冒烟测试，CI 执行。
- 文档与可观测：
  - 强化 README 与 `docs/环境配置.md` 的切换说明与常见错误排查路径。
  - 保持 `org.hibernate.SQL=DEBUG` 在开发环境开启，便于快速定位数据库问题。

---

## 变更记录（Change Log）
- 新增：`end/src/main/resources/db/migration/V20251231__alter_threads_content_to_varchar.sql`。
- 修改：`end/src/main/resources/application.yml` → 默认 `spring.profiles.active=mysql`。
- 修改：`end/src/main/resources/application-mysql.yml` → 默认 `username: root`、`password: 04126`。
- 前端：`front/.env` 已设置 `VITE_API_BASE_URL` 与 `VITE_USE_API_MOCK=false`（无需变更）。

---

## 附录：关键文件与路径
- 后端 POM：`end/pom.xml`（含 `spring-boot-maven-plugin`）。
- 配置文件：
  - `end/src/main/resources/application.yml`
  - `end/src/main/resources/application-mysql.yml`
  - `end/src/main/resources/application-local.yml`
- 迁移脚本：
  - `end/src/main/resources/db/migration/`
  - `end/src/main/resources/db/migration/mysql/`