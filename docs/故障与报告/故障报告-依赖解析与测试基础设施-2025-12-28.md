# 故障报告：依赖解析与测试基础设施问题（2025-12-28）

## 概述
- 后端模块在引入 MyBatis-Plus 分页拦截器与升级到 Spring Boot 4 后，出现编译与测试依赖解析问题，导致构建失败和测试无法运行。
- 本报告记录问题现象、根因分析、修复过程与验证结果，并给出后续建议。

## 影响范围
- 模块：`end` 后端服务。
- 影响：
  - 编译失败：`PaginationInnerInterceptor` 找不到类。
  - 测试失败：`@AutoConfigureMockMvc` 找不到包。
  - 依赖解析失败：`org.mybatis:mybatis-spring:4.0.0` 报错无法解析。

## 现象与错误信息
- 编译失败（MyBatis-Plus）：
  - `MybatisPlusConfig.java:4:56 cannot find symbol PaginationInnerInterceptor in com.baomidou.mybatisplus.extension.plugins.inner`
- 测试失败（Spring Boot 4）：
  - `ThreadsControllerContractJPAIT.java` 中 `org.springframework.boot.test.autoconfigure.web.servlet.AutoConfigureMockMvc` 包不存在。
- 依赖解析失败（MyBatis-Spring）：
  - 找不到依赖项 `org.mybatis:mybatis-spring:4.0.0`，或解析报错。

## 根因分析
- MyBatis-Plus 分页模块拆分：
  - 自 `3.5.9` 起，分页相关实现拆分到 `mybatis-plus-jsqlparser`，`PaginationInnerInterceptor` 仍在 `com.baomidou.mybatisplus.extension.plugins.inner`，但需要额外引入 `jsqlparser`。
- Spring Boot 4 测试模块模块化：
  - `@AutoConfigureMockMvc` 迁移到 `org.springframework.boot.webmvc.test.autoconfigure`，并需添加 `spring-boot-starter-webmvc-test`。
  - `@SpringBootTest` 不再自动提供 MockMvc，需要显式 `@AutoConfigureMockMvc`。
- 坐标/仓库配置问题：
  - `mybatis-spring` 的正确坐标为 `org.mybatis:mybatis-spring`，不是 `org.mybatis.spring:mybatis-spring`。
  - 若本地 Maven 配置不包含 Central 或被镜像覆盖，可能导致 `4.0.0` 无法解析。

## 复现步骤
1. 在激活 `mp-boot4` Profile 的情况下执行：
   - `mvn -f end/pom.xml -DskipTests clean compile`
2. 观察到上述三类错误分别在编译与测试阶段出现。

## 修复过程与改动
- POM 依赖修复（`end/pom.xml`）：
  - 在 Profiles 中添加/确认 MyBatis-Plus 依赖：
    - `com.baomidou:mybatis-plus-extension:${mp.bootX.version}`
    - `com.baomidou:mybatis-plus-jsqlparser:${mp.bootX.version}`（新增，Boot3/Boot4 两条线均已加入）
  - 添加测试基础设施：
    - `org.springframework.boot:spring-boot-starter-webmvc-test`（scope `test`）
  - 更正依赖管理坐标：
    - 将 `mybatis-spring` 的 `groupId` 更正为 `org.mybatis`（Boot4 使用 `4.0.0`，Boot3 使用 `3.0.5`）。
  - 仓库配置：
    - 在 `<repositories>` 中显式加入 Maven Central：`https://repo1.maven.org/maven2`，启用 `releases`，禁用 `snapshots`。

- 测试代码修复：
  - 更新导入到新包：
    - `end/src/test/java/com/example/demo/threads/ThreadsControllerContractJPAIT.java`
    - `end/src/test/java/com/example/demo/threads/ThreadsControllerContractMPIT.java`
    - 由 `org.springframework.boot.test.autoconfigure.web.servlet.AutoConfigureMockMvc` 改为 `org.springframework.boot.webmvc.test.autoconfigure.AutoConfigureMockMvc`。

## 验证结果
- 依赖拉取与编译：
  - `mvn -f end/pom.xml -DskipTests clean compile` — 成功，`mybatis-plus-jsqlparser` 与相关依赖已解析。
- 测试建议命令：
  - `mvn -f end/pom.xml -DskipTests=false -DfailIfNoTests=false test`
- 若仅验证 MyBatis-Spring 依赖解析：
  - `mvn -f end/pom.xml -U dependency:get -Dartifact=org.mybatis:mybatis-spring:4.0.0`

## 残留风险与建议
- 建议统一依赖管理：
  - 使用 Profiles 明确区分 Boot3 与 Boot4 的依赖组合，避免版本漂移。
  - 测试依赖按技术选择对应 `*-test` starter，避免仅依赖 `spring-boot-starter-test`。
- IDE 同步：
  - 修改 POM 后，需执行 Maven 重新导入与索引重建，避免包解析误报。
- 仓库与网络：
  - 检查 `~/.m2/settings.xml` 的 `mirrors` 与私服代理是否正确代理 Central。

## 关键修改清单
- `end/pom.xml`：
  - 添加 `com.baomidou:mybatis-plus-jsqlparser`（Boot3/Boot4）。
  - 添加 `org.springframework.boot:spring-boot-starter-webmvc-test`（test）。
  - 更正 `org.mybatis:mybatis-spring` 的 `groupId`。
  - 添加 `<repository id="central">https://repo1.maven.org/maven2</repository>`。
- 测试文件：
  - `ThreadsControllerContractJPAIT.java` / `ThreadsControllerContractMPIT.java` 导入包改为 `org.springframework.boot.webmvc.test.autoconfigure.AutoConfigureMockMvc`。

## 参考链接
- Spring Boot 4 迁移指南（测试模块与 starter）：
  - https://github.com/spring-projects/spring-boot/wiki/Spring-Boot-4.0-Migration-Guide
- `@AutoConfigureMockMvc`（Spring Boot 4 API）：
  - https://docs.spring.io/spring-boot/api/java/org/springframework/boot/webmvc/test/autoconfigure/AutoConfigureMockMvc.html
- MyBatis-Spring 4.0.0（Maven Central）：
  - https://central.sonatype.com/artifact/org.mybatis/mybatis-spring