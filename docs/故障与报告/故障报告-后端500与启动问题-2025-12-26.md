# 开发故障报告：后端 500（本地 H2 未迁移）与启动参数问题

- 日期：2025-12-26
- 作者：开发助手（协作排查）
- 环境：Windows、JDK 21、Maven Wrapper、Vite 5、MySQL 8（本机）
- 影响范围：本地联调环境（前端 `front`、后端 `end`）

---

## 摘要
- 前端到后端 HTTP 链路正常，但后端接口返回 500。根因是后端 `local`（H2）环境未执行建表迁移，导致访问依赖表结构的接口时抛出数据库层错误。
- 排查/修复过程中遇到两处启动问题：
  1) Maven 启动参数格式错误，出现 `Unknown lifecycle phase`；
  2) 在错误的目录（`end/end`）下运行导致 `NoPluginFoundForPrefixException`。
- 采用 MySQL 方案启动后端并执行 Flyway `mysql` 迁移，接口恢复 200。

---

## 症状与影响
- 症状：前端页面正常发起请求，但后端 `/api/v1/sections`、`/api/v1/threads` 返回 500。
- 影响：无法浏览分区列表与主题帖列表，前后端联调阻断。

---

## 环境与配置概览
- 前端
  - `.env`：`VITE_API_BASE_URL=http://localhost:8080/api/v1`
  - 无 Vite 代理；Axios 客户端 `baseURL` 与 `.env` 一致。
- 后端
  - `end/src/main/resources/application.yml`：`spring.profiles.active=local`（默认）
  - `application-local.yml`：H2 数据源、`ddl-auto: none`、默认 `flyway.locations=classpath:db/migration`
  - 实际建表脚本位于：`end/src/main/resources/db/migration/mysql/`
  - 安全配置允许所有路径、CORS 已允许 `http://localhost:5173` 访问 `/api/**`

---

## 时间线
- T0：前端请求 500，确认前端 `baseURL` 与路由配置正常；后端安全配置与 CORS 正常。
- T1：确认 `local` profile 使用 H2，`ddl-auto:none`，且默认迁移路径下无建表脚本；实际脚本在 `mysql` 目录，导致 H2 下表缺失。
- T2：临时尝试将 `application-local.yml` 的 Flyway 迁移路径改为 `classpath:db/migration/mysql`（便于验证）。
- T3：打包时发生 `spring-boot-maven-plugin:repackage` 重命名冲突（推测之前实例占用），改用直接运行。
- T4：使用 Maven 目标运行时参数格式错误，出现 `Unknown lifecycle phase ".run.profiles=local"`。
- T5：在错误目录 `end/end` 启动，报 `No plugin found for prefix 'spring-boot'`。
- T6：回到正确目录 `end/`，设置 MySQL 连接参数与 `SPRING_PROFILES_ACTIVE=mysql`，后端成功启动；Flyway 执行 `mysql` 迁移。
- T7：接口验证成功，`/sections` 与 `/threads` 返回 200。

---

## 复现与日志片段
- 错误的 Maven 参数：
```powershell
# 错误示例（会报 Unknown lifecycle phase）
.\mvnw.cmd .run.profiles=mysql
# 正确示例（两种方式之一）
.\mvnw.cmd spring-boot:run -Dspring-boot.run.profiles=mysql
$env:SPRING_PROFILES_ACTIVE="mysql"; .\mvnw.cmd spring-boot:run
```

- 错误目录导致插件无法识别：
```text
[ERROR] No plugin found for prefix 'spring-boot' in the current project
```

- 启动成功日志关键片段：
```text
Tomcat started on port 8080 (http) with context path '/'
Initialized JPA EntityManagerFactory for persistence unit 'default'
Flyway 迁移执行：V2__create_users.sql, V4__create_sections.sql, V5__create_threads.sql ...
```

- 接口验证：
```powershell
Invoke-RestMethod -Uri "http://localhost:8080/api/v1/sections"
Invoke-RestMethod -Uri "http://localhost:8080/api/v1/threads"
# 返回 200，sections 列表包含预置数据；threads 返回分页数据
```

---

## 根因分析
- 主根因：`local`（H2）环境未建表。
  - H2 数据源 + `ddl-auto: none`（禁用自动建表）
  - 默认 Flyway 路径下无建表脚本，真实脚本在 `db/migration/mysql/`
  - 访问 `sections`、`threads` 等接口触发 JPA 查询，落到数据库层报 "Table not found"，最终表现为 HTTP 500。
- 次要问题：启动过程中的参数与目录错误，导致不必要的失败与时间消耗。

---

## 处置与修复
- 采用 MySQL 方案（本机已安装，密码 `04126`）：
```powershell
# 创建数据库（已执行）
mysql -u root -p04126 -e "CREATE DATABASE IF NOT EXISTS MagicAlbum CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci;"

# 设置连接参数并启动（在 end 目录）
$env:DB_HOST="localhost"; $env:DB_PORT="3306"; $env:DB_NAME="MagicAlbum"; `
$env:DB_USER="root"; $env:DB_PASSWORD="04126"; `
$env:SPRING_PROFILES_ACTIVE="mysql"; .\mvnw.cmd spring-boot:run
```
- 验证：
```powershell
Invoke-RestMethod -Uri "http://localhost:8080/api/v1/sections"
Invoke-RestMethod -Uri "http://localhost:8080/api/v1/threads"
```
- 前端联调：
  - `.env`：`VITE_API_BASE_URL=http://localhost:8080/api/v1`
  - `npm run dev` → `http://localhost:5173/sections`

---

## 经验教训与改进建议
- 配置一致性
  - 保持各 `profile` 的 Flyway 迁移路径一致或提供对应脚本，避免某环境下缺表。
  - 在 `application.yml` 中明确注释 profile 默认值与切换方式，避免误用 `local`。
- 启动健壮性
  - 增加启动前置检查（如在 `ApplicationRunner` 中检测关键表存在），必要时输出友好错误并指向文档。
  - 提供标准启动脚本（Windows/Unix），封装 `DB_*` 环境变量与 `SPRING_PROFILES_ACTIVE`，降低手误概率。
- 测试保障
  - 引入 `Testcontainers` 做集成测试，确保迁移脚本在 MySQL/Postgres 都能通过。
  - 为核心接口增加冒烟测试，CI 中执行。
- 文档与可观测
  - README 与 `docs/环境配置.md` 强化 MySQL/Postgres 切换说明与常见错误。
  - 保持 `org.hibernate.SQL=DEBUG` 在开发环境开启，便于快速定位数据库问题。

---

## 附录：关键文件与路径
- 后端 POM：`end/pom.xml`（含 `spring-boot-maven-plugin`）
- 配置文件：
  - `end/src/main/resources/application.yml`
  - `end/src/main/resources/application-mysql.yml`
  - `end/src/main/resources/application-local.yml`
- 迁移脚本：`end/src/main/resources/db/migration/mysql/`
- 前端环境：`front/.env`、`front/src/api/client.js`

> 备注：本报告为本地开发环境故障记录，涉及的本机数据库密码为示例值（此次为 `04126`）。如需提交到公共仓库，请将敏感信息替换为占位符。