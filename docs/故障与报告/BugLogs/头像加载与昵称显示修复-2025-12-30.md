# 修复归档：头像加载与昵称显示问题

## 1. Bug描述

### 表现与重现
在发现页面（Discover）和帖子详情页（ThreadDetail）中，用户头像无法正确加载，显示为默认的占位图（灰底或 DiceBear 首字母头像）。同时，用户昵称显示错误，直接显示了用户名字段（username）而非昵称字段（nickname）。

**重现步骤：**
1. 启动后端服务和前端服务。
2. 访问发现页面 `/discover`。
3. 观察帖子列表项中的作者头像和昵称。
4. 头像显示为带有 "FU"（Fucking User）或 "WO"（Working User）的 DiceBear 默认图，或灰色空白圆圈。
5. 昵称显示为 "fuckinguser" 而非 "workinguser"。

### 环境条件
- **操作系统**: Windows
- **前端环境**: Vue 3 + Vite
- **后端环境**: Spring Boot 4.0.1 (Experimental) + PostgreSQL/MySQL
- **浏览器**: Chrome (最新版)

### 证据
- **截图**: 用户提供的截图显示头像为 "FU"/"WO" 圆圈，昵称显示为 username。
- **日志**: 后端 `curl` 测试显示 API 返回的 `ThreadDto` 曾缺失 `authorAvatar` 和 `authorNickname` 字段。前端编译曾报错 `normalizeImageUrl` 重复声明。

## 2. 修复过程

### 根本原因分析
1. **后端数据缺失**: `ThreadDto` 和 `PostDto` 未包含 `authorNickname` 和 `authorAvatar` 字段，且 Service 层（`ThreadService`, `PostService`）未查询并填充这些信息。导致前端只能回退到 username 和基于 username 生成的默认头像。
2. **前端逻辑冗余与错误**: 前端页面（Discover.vue, ThreadDetail.vue）尝试通过异步请求 `getUserProfile` 或本地缓存来补充头像信息，但该逻辑与后端数据流不匹配，且存在 bug（未正确设置 avatar ref），导致即使后端修复了数据，前端仍使用无效的本地状态。
3. **代码冲突**: `Comments.vue` 中引入了 `normalizeImageUrl` 工具函数，但本地又重复声明了同名函数，导致编译错误。

### 修复方案
1. **后端改造**:
   - 修改 `PostDto.java` 和 `ThreadDto.java`，增加 `authorNickname`, `authorAvatar` 等字段。
   - 修改 `ThreadService.java` 和 `PostService.java`，注入 `UserProfileRepository`，在 DTO 转换时查询并填充用户信息。
2. **前端重构**:
   - 修复 `Comments.vue` 的编译错误，移除重复函数。
   - 重构 `Discover.vue` 和 `ThreadDetail.vue`，删除冗余的 `getUserProfile` 异步请求逻辑，直接使用后端 API 返回的 `t.authorAvatar` 和 `t.authorNickname`。
   - 统一使用 `normalizeImageUrl` 处理头像 URL。

### 代码修改 (Diff 摘要)

**后端 (ThreadService.java):**
```java
+ private final UserProfileRepository userProfileRepository;
// ... 构造函数注入 ...
// toDto 方法:
+ UserProfile profile = userProfileRepository.findById(t.getAuthorId()).orElse(null);
+ if (profile != null) {
+     dto.setAuthorNickname(profile.getNickname());
+     dto.setAuthorAvatar(profile.getAvatarUrl());
+ }
```

**前端 (Discover.vue):**
```vue
- :src="profiles[t.authorId]?.avatar ? ..."
+ :src="t.authorAvatar ? normalizeImageUrl(t.authorAvatar) : ..."
- {{ profiles[t.authorId]?.nickname || ... }}
+ {{ t.authorNickname || t.authorUsername || t.authorId }}
```

**前端 (Comments.vue):**
```javascript
- function normalizeImageUrl(u) { ... } // 删除重复声明
```

### 版本信息
- **修复日期**: 2025-12-30
- **提交ID**: (本次会话即时修改)

## 3. 验证结果

### 测试方法
1. **API 验证**: 使用 `curl` 请求 `/api/v1/threads`，确认响应 JSON 中包含 `authorAvatar` 和 `authorNickname` 且值正确。
2. **静态资源验证**: 确认头像文件存在于服务器 `uploads/threads/...` 路径下，且 `WebConfig` 配置正确。
3. **界面验证**: 刷新前端页面，确认头像显示为用户上传图片，昵称显示为 "workinguser"。

### 测试数据
- **用户**: workinguser (ID: 4)
- **头像文件**: `uploads/threads/2025/12/30/2e015b4069b540ca93c59618b1a9915d.jpg`
- **验证结果**: 
  - API 响应: `{"authorAvatar": "/uploads/...", "authorNickname": "workinguser", ...}`
  - 页面显示: 头像正常加载，昵称正确。

## 4. 影响评估

### 模块影响
- **发现页/详情页**: 性能提升，减少了对 `/api/v1/users/{id}/profile` 的 N+1 次请求。
- **评论区**: 修复了功能并提升了加载速度。

### 兼容性
- **API 变更**: API 响应增加了字段，对旧版前端（如有）无破坏性影响（字段会被忽略）。
- **部署**: 需要重启后端服务以生效。

## 5. 归档信息

- **归档日期**: 2025-12-30
- **负责人**: Trae AI
- **存储位置**: `docs/故障与报告/BugLogs/`
