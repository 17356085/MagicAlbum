# 缺陷修复记录

更新时间：2025-12-27

## 2025-12-27

- 我的评论页面显示不直观（仅显示所属帖子编号）
  - 现象：`MyPosts.vue` 中“所属帖子：#<threadId>` 不易辨认。
  - 处理：后端 `PostDto` 新增 `threadTitle` 字段并在 `PostService.toDto` 中填充；前端优先显示 `threadTitle`，缺失时回退为 `#threadId`。

- 从“我的评论”跳转无法定位具体评论
  - 现象：跳转到帖子详情后，页面未自动滚动到目标评论。
  - 处理：统一锚点约定 `/threads/{threadId}#post-{postId}`；`ThreadDetail.vue` 解析 `route.hash` 并传递到 `Comments.vue` 的 `scrollToPostId`；`Comments.vue` 展开包含目标的楼层、切换分页并平滑滚动到视图中心。

- 登出后页面仍残留登录态数据
  - 现象：登出后部分页面仍显示登录时的数据或用户信息。
  - 处理：`useAuth.logout()` 清理本地存储并强制刷新；同时在“设置/我的帖子/我的评论”页面登出时先重定向到“发现”页，再执行登出与刷新，确保退出后停留在公共页面。

- 登录后未及时更新全站状态
  - 现象：登录成功后，部分页面仍按未登录状态显示。
  - 处理：`useAuth.loginWithPhonePassword / loginWithEmailPassword` 成功后立即触发强制刷新，确保全站重新初始化。

## 已知问题与建议

- 评论定位的高亮样式需统一；在极长楼层分页中，定位后可能需要额外提示。
- 强制刷新会造成轻微闪烁，后续可考虑改为软刷新（清空相关状态 + 重新拉取数据），并按页面粒度优化。
### 2025-12-27 顶栏搜索点击建议项未更新个人页面

- 症状：在用户个人页打开后，通过顶栏搜索另一个用户并点击建议列表头像/项，页面看起来没有跳转到新用户的个人页。
- 复现路径：
  1) 进入某用户个人页 `/users/:id`；
  2) 顶栏切换到“搜用户”，输入关键字；
  3) 在联想建议中点击另一位用户的头像或行；
  4) 观察页面仍显示旧用户信息。
- 根因分析：`UserProfile.vue` 中 `userId` 取自 `route.params.id` 的一次性赋值，未随路由参数变化而更新；同时仅监听 `route.params.id` 重载了帖子列表，未重新获取个人资料，且帖子加载也继续使用旧 `userId`。
- 修复方案：
  - 将 `userId` 改为 `computed(() => route.params.id)`，确保对路由变化响应；
  - 在 `watch(userId, ...)` 中：重新获取个人资料、重置分页并加载该用户的帖子；
  - `listUserThreads`、`getUserProfile` 调用改为使用 `userId.value`。
- 受影响文件：`front/src/pages/UserProfile.vue`
- 验证：在个人页重复上述路径，点击不同建议项能够正确跳转并刷新头像、昵称、介绍与帖子列表；URL 与内容一致。
### 2025-12-27 隐私优化：用户搜索仅按用户名/昵称匹配

- 背景：顶栏与“搜索用户”页默认会按用户名/邮箱/手机号进行匹配，可能导致通过邮箱/手机号查找用户，存在隐私风险。
- 变更：前端层面限制搜索匹配字段为“用户名/昵称”，不再按邮箱/手机号进行匹配；仍可在列表中展示邮箱，但不会用于匹配与高亮。
- 实现：
  - `HeaderBangumi.vue` 增加 `visibleSuggestions` 过滤，仅保留用户名或昵称符合关键字的建议项；占位文案改为“搜索用户名/昵称”，移除对邮箱的高亮。
  - `UsersSearch.vue` 新增 `filteredItems` 计算属性，对列表进行同样过滤，并将统计显示为“匹配数”。
- 取舍：后端若仍按邮箱/手机号匹配返回结果，则前端会在显示层过滤，分页统计与后端总数可能不完全一致；如需完全一致，建议后端增加搜索字段限制参数。
- 验证：输入邮箱或手机号作为关键字，建议与列表均不返回仅邮箱/手机号匹配的用户；输入用户名或昵称，能正确匹配与跳转。

### 2025-12-27 昵称搜索无结果（后端不支持昵称索引的回退）

- 背景：在限制搜索仅按“用户名/昵称”后，部分环境的后端 `/users?q=...` 仅按用户名匹配，导致输入仅存在于昵称中的关键字时没有任何结果。
- 变更：
  - 新增 `front/src/api/users.js` 中的 `searchUsersByNickname(keyword)`，在后端不支持昵称匹配时，前端分页扫描 `/users?page&size` 并拉取 `profile`，以昵称或用户名进行过滤，返回匹配集合。
  - `front/src/components/HeaderBangumi.vue` 在 `suggestUsers` 返回为空时启用昵称回退，确保联想建议按昵称也能命中。
  - `front/src/pages/UsersSearch.vue` 在 `listUsers` 返回为空时启用昵称回退；同时将空态判断从 `items.length` 改为 `filteredItems.length`，与隐私过滤逻辑保持一致。
- 取舍：为避免过高开销，默认扫描页数限制为 1~5 页；建议后端补充昵称搜索索引或参数后，移除该前端回退逻辑。
- 验证：输入仅存在于昵称中的关键字（如 `work`），顶栏建议与“搜索用户”列表均能出现目标用户；分页与计数显示正常，邮箱仍显示但不参与匹配。

### 2025-12-27 后端支持昵称搜索后移除前端回退

- 背景：后端已补充对昵称的搜索索引或参数，`GET /users?q=...` 能同时精确匹配“用户名/昵称”。
- 变更：
  - 移除 `front/src/api/users.js` 的 `searchUsersByNickname` 回退方法。
  - `front/src/components/HeaderBangumi.vue` 与 `front/src/pages/UsersSearch.vue` 不再调用回退逻辑，完全依赖后端返回。
  - 保留显示层的隐私过滤（仅按用户名/昵称），以防止邮箱/手机号参与匹配或高亮。
- 验证：输入仅存在于昵称的关键字能直接由后端返回匹配结果；前端列表与建议项与后端总数保持一致，无多余前端分页扫描。

### 2025-12-27 后端增加 fields 参数以精确控制搜索字段

- 背景：需要在不暴露邮箱/手机号匹配的情况下，支持“用户名/昵称”精准搜索，并为后续移除前端回退提供能力。
- 变更：
  - `GET /api/v1/users` 新增可选查询参数 `fields`（示例：`fields=username,nickname`）。
  - 当包含 `nickname` 时，后端在用户查询中使用 `EXISTS (SELECT 1 FROM user_profiles WHERE user_id = users.id AND nickname LIKE ...)` 参与匹配。
  - 控制层：`UserController.list` 接收 `fields` 并传递到服务层。
  - 服务层：`UserService.list(q, page, size, fields)` 根据是否包含 `nickname` 选择调用 `UserRepository.searchWithNickname` 或 `search`。
  - 仓储层：`UserRepository.searchWithNickname` 新增 JPQL，含昵称 `EXISTS` 子查询。
  - 前端：`listUsers` 与 `suggestUsers` 发起请求时携带 `fields=username,nickname`，并移除昵称回退逻辑。
- 验证：
  - 顶栏“搜用户”输入仅存在于昵称的关键字，联想建议出现匹配项（最多 5 条）；点击后跳转正确。
  - “搜索用户”页同样出现匹配列表；“匹配数”与后端 `total` 一致。